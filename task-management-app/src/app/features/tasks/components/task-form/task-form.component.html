<div class="task-form-container">
  <!-- Page header -->
  <app-page-header
    [title]="isEditMode ? 'Edit Task' : 'Create Task'"
    [showBackButton]="true"
    (backClick)="cancel()">
  </app-page-header>

  <!-- Loading spinner -->
  <app-loading-spinner
    *ngIf="loading && isEditMode"
    [message]="'Loading task...'">
  </app-loading-spinner>

  <!-- Task form -->
  <mat-card class="form-card" *ngIf="!loading || !isEditMode">
    <form [formGroup]="taskForm" (ngSubmit)="onSubmit()">
      <!-- Title -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Title</mat-label>
        <input
          matInput
          formControlName="title"
          placeholder="Enter task title"
          maxlength="200">
        <mat-hint align="end">{{ f['title'].value?.length || 0 }}/200</mat-hint>
        <mat-error *ngIf="f['title'].hasError('required')">
          Title is required
        </mat-error>
        <mat-error *ngIf="f['title'].hasError('minlength')">
          Title must be at least 3 characters
        </mat-error>
      </mat-form-field>

      <!-- Description -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Description</mat-label>
        <textarea
          matInput
          formControlName="description"
          placeholder="Enter task description"
          rows="4"
          cdkTextareaAutosize
          cdkAutosizeMinRows="4"
          cdkAutosizeMaxRows="10">
        </textarea>
        <mat-error *ngIf="f['description'].hasError('required')">
          Description is required
        </mat-error>
        <mat-error *ngIf="f['description'].hasError('minlength')">
          Description must be at least 10 characters
        </mat-error>
      </mat-form-field>

      <!-- Status and Priority Row -->
      <div class="form-row">
        <!-- Status -->
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Status</mat-label>
          <mat-select formControlName="status">
            <mat-option *ngFor="let status of statuses" [value]="status">
              {{ formatStatus(status) }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="f['status'].hasError('required')">
            Status is required
          </mat-error>
        </mat-form-field>

        <!-- Priority -->
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Priority</mat-label>
          <mat-select formControlName="priority">
            <mat-option *ngFor="let priority of priorities" [value]="priority">
              {{ priority }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="f['priority'].hasError('required')">
            Priority is required
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Assigned To and Due Date Row -->
      <div class="form-row">
        <!-- Assigned To -->
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Assigned To (Optional)</mat-label>
          <input
            matInput
            formControlName="assignedTo"
            placeholder="Enter user ID">
          <mat-icon matPrefix>person</mat-icon>
        </mat-form-field>

        <!-- Due Date -->
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Due Date (Optional)</mat-label>
          <input
            matInput
            [matDatepicker]="picker"
            formControlName="dueDate">
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>
      </div>

      <!-- Estimated Hours -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Estimated Hours (Optional)</mat-label>
        <input
          matInput
          type="number"
          formControlName="estimatedHours"
          placeholder="Enter estimated hours"
          min="0"
          step="0.5">
        <mat-icon matPrefix>schedule</mat-icon>
        <mat-error *ngIf="f['estimatedHours'].hasError('min')">
          Hours must be positive
        </mat-error>
      </mat-form-field>

      <!-- Tags -->
      <div class="tags-section">
        <mat-label>Tags (Optional)</mat-label>
        <mat-chip-list #chipList aria-label="Task tags">
          <mat-chip
            *ngFor="let tag of tags"
            [removable]="true"
            (removed)="removeTag(tag)">
            {{ tag }}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip>
          <input
            placeholder="Add tag and press Enter..."
            [matChipInputFor]="chipList"
            [matChipInputSeparatorKeyCodes]="[13, 188]"
            [matChipInputAddOnBlur]="true"
            (matChipInputTokenEnd)="addTag($event)">
        </mat-chip-list>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button
          mat-button
          type="button"
          (click)="cancel()">
          Cancel
        </button>
        <button
          mat-raised-button
          color="primary"
          type="submit"
          [disabled]="loading">
          <span *ngIf="!loading">{{ isEditMode ? 'Update Task' : 'Create Task' }}</span>
          <mat-spinner *ngIf="loading" diameter="20"></mat-spinner>
        </button>
      </div>
    </form>
  </mat-card>
</div>
